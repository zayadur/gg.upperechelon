!function($,window,document,undefined){"use strict";var editorVal="",inactiveBlockClass="sm-inactive",editing=!1,updated=!1,dialogEditOpened=!1,blockPositions={},emptyPositionsObj={},template={},origin={},inlineForm={},dialogConfirm={},dialogEdit={},dialogCopy={},cButtons={},dButtons={},eButtons={},lButtons={},blockObj={},blockData={editable:" editable",block:{}},msgObj={},saveBtn={},lang={},config={},editMode=!1,phpbb={},tinymce={},Twig={},fixPaths=function(t){return t.replace(new RegExp("(?:href|src)=(?:\"|')((?:./)?(?:../)+)(?:.*?)(?:\"|')","gmi"),function(t,o){return t.replace(o,config.webRootPath)})},removeGrid=function(t){t.removeClass(function(){var t=this.className.match(/grid__col+(\S+)?/gi);return t?t.join(" "):""})},sortHorizontal=function(t){var o=t.length,e=void 0!==t.parent().data("columns")?t.parent().data("columns")<=5?t.parent().data("columns"):5:3,i=o%e,n=o-i;if(o<=e)e=o;else if(t.parent().hasClass("equal")){if(i>0&&e>3)for(var a=1;a<i;a++)if(o%(e-a)==0){e-=a;break}n=o,i=0}if(removeGrid(t),n>0&&t.slice(0,n).addClass("grid__col grid__col--1-of-"+e+" grid__col--m-1-of-"+e),i){var l=1;i<2&&(l=5,i=5),t.slice(n,o).addClass("grid__col grid__col--"+l+"-of-"+i+" grid__col--m-"+l+"-of-"+i)}},showAllPositions=function(){blockPositions.addClass("show-position"),emptyPositionsObj.removeClass("empty-position").siblings(".grid__col").removeClass("lastUnit")},hideEmptyPositions=function(){blockPositions.removeClass("show-position"),emptyPositionsObj=$('.block-position:not(:has(".block"))').addClass("empty-position").each(function(){$(this).siblings(".grid__col").last().addClass("lastUnit")})},makeEditable=function(t){if(!0===editing)return void inlineForm.children(":input").trigger("blur");editing=!0,editorVal=t.removeClass("editable").text(),inlineForm.show().appendTo(t.text("")).children(":input").val(editorVal).focus().select().end()},undoEditable=function(t){var o=inlineForm.parent();editing=!1,editorVal="",o.addClass("editable").text(t),inlineForm.hide().appendTo($("body"))},renderBlock=function(blockObj,blockData){var id="block-editor-"+blockData.block.id,editor=tinymce.get(id);editor&&tinymce.EditorManager.remove(editor),blockData.block.content=fixPaths(blockData.block.content),blockObj.html(template.render(blockData)),"blitze.sitemaker.block.custom"===blockData.block.name&&(blockObj.find("#"+id).length?tinymce.EditorManager.execCommand("mceAddEditor",!1,id):blockData.data.content.indexOf("script")>-1&&eval(blockObj.find(".sm-block-content").html()))},saveLayout=function(){var t={};$(".block-position").each(function(){var o=0,e=$(this).attr("id");$(this).find(".block").each(function(){var i=$(this).attr("id");if(void 0!==e&&void 0!==i){var n=i.substring(6);t[n]={position:e.substring(4),weight:o},o++}})}),$.post(config.ajaxUrl+"/blocks/save_blocks",{route:config.route,blocks:t},function(){saveBtn.button("disable"),updated=!1})},addBlock=function(t,o,e){$(e).removeAttr("role aria-disabled data-block class style").addClass("block").html('<div class="ui-state-highlight sm-block-spacing sortable" style="padding: 5px"><i class="fa fa-spinner fa-2x fa-spin"></i> '+lang.ajaxLoading+"</div>");var i={block:$.trim(o),weight:e.parent().find(".block").index(e),route:config.route,ext:config.ext,position:t};$.getJSON(config.ajaxUrl+"/blocks/add_block",i,function(t){if(updated=!1,""===t.id)return void $(e).remove();var o=$(e).attr("id","block-"+t.id);renderBlock(o,{block:t}),o.children().not(".block-controls").show("scale",{percent:100},1e3),updated&&saveLayout()})},getEditForm=function(t){$.getJSON(config.ajaxUrl+"/blocks/edit_block",{id:t.attr("id").substring(6)},function(t){blockData.block=t,t.form&&(dialogEdit.html(t.form),dialogEdit.find("#block-settings").tabs(),dialogEdit.find("select[data-togglable-settings]").each(function(){var t=$(this);t.change(function(){phpbb.toggleSelectSettings(t)}),phpbb.toggleSelectSettings(t)}),dialogEdit.dialog({buttons:eButtons}).dialog("option","title",lang.edit+" - "+t.title).dialog("open"))})},getCustomClasses=function(){return dialogEdit.find("#block_class").text().trim()},saveForm=function(t){var o=$("#edit_form"),e=dialogEdit.dialog("widget").find("#update-similar:checked").length,i={id:t.attr("id").substring(6),route:config.route,similar:e,class:getCustomClasses()};o.serializeArray().map(function(t){i[t.name]=t.value}),i["config[source]"]&&(i["config[source]"]=encodeURI(i["config[source]"])),dialogEdit.dialog("close"),$.post(config.ajaxUrl+"/blocks/save_block",i,function(t){t.list&&$.each(t.list,function(t,o){renderBlock($("#block-"+o.id),{block:o})})})},updateBlock=function(t){if(void 0===t.id)return!1;$.post(config.ajaxUrl+"/blocks/update_block?route="+config.route,t,function(t){!0===editing&&undoEditable(t.title)},"json")},customBlockAction=function(t){void 0!==t.id&&$.post(config.ajaxUrl+"/blocks/handle_custom_action",t,function(t){if(t.id){var o="block-editor-"+t.id,e=fixPaths(t.content),i=$("#block-"+t.id+" > .sm-block-container"),n=$("#"+o).attr("data-raw",e);tinymce.get(o).setContent(e||lang.placeholder),t.content&&n.data("active")?i.removeClass("sm-inactive"):i.addClass("sm-inactive")}})},setDefaultLayout=function(t){$.post(config.ajaxUrl+"/blocks/set_default_route?route="+(!0===t?config.route:""))},setStartPage=function(t){$.post(config.ajaxUrl+"/blocks/set_startpage",$.param(t))},setRoutePrefs=function(t,o){$.post(config.ajaxUrl+"/blocks/set_route_prefs?route="+config.route+"&ext="+config.ext,t.serialize(),function(){blockPositions.removeClass("sm-inactive"),o&&hidePositions(o)})},copyBlocks=function(t){var o=$(".block-position");$.getJSON(config.ajaxUrl+"/blocks/copy_route?route="+config.route+"&ext="+config.ext+"&"+$.param(t),function(t){0!==t.list.length&&(showAllPositions(),o.empty(),$.each(t.list,function(t,o){var e=$("#pos-"+t);$.each(o,function(t,o){blockData.block=o,e.append('<div id="block-'+o.id+'" class="unit size1of1 block"></div>'),renderBlock(e.find("#block-"+o.id),blockData)}),e.hasClass("horizontal")&&sortHorizontal(e.find(".block"))}),hideEmptyPositions())})},processInput=function(t){if(!1!==editing){var o=$(t).parentsUntil(".block").parent().attr("id").substring(6),e=$(t).val();return o&&e!==editorVal?updateBlock({id:o,field:"title",title:e}):undoEditable(editorVal),!1}},previewBlock=function(){var t=$.extend(!0,{},blockData),o=dialogEdit.find("#edit_form").serializeArray(),e=getCustomClasses();$.each(o,function(){t.block[this.name]="boolean"==typeof t.block[this.name]?"1"===this.value:this.value}),t.block.class=e?" "+e:"",renderBlock(blockObj,t)},undoPreviewBlock=function(){renderBlock(blockObj,blockData)},initTinyMce=function(){tinymce.init({selector:"div.editable-block",inline:!0,image_advtab:!0,hidden_input:!1,plugins:["advlist autolink lists link image charmap preview hr anchor pagebreak","visualblocks visualchars code","media nonbreaking save table contextmenu directionality","paste textcolor colorpicker textpattern"],toolbar:["undo redo | styleselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify","bullist numlist outdent indent | hr pagebreak | image media | link | table | preview code"],valid_elements:"*[*]",end_container_on_empty_block:!0,setup:function(t){var o={},e=!0,i="",n="";t.on("init",function(){0===t.getContent().length&&t.setContent(lang.placeholder)}),t.on("focus",function(){var a=t.id.substring(13);o=$("#block-"+a+" > .sm-block-container"),e=o.hasClass("sm-inactive"),n=$("#"+t.id).data("raw"),i=t.getContent({format:"raw"}),t.setContent(n)}),t.on("keyUp",function(){e&&t.getContent().length?(e=!1,o.removeClass("sm-inactive")):e||t.getContent().length||(e=!0,o.addClass("sm-inactive"))}),t.on("blur",function(){var o=t.getContent({format:"raw"}).replace('<p><br data-mce-bogus="1"></p>',""),e=t.getContent();if(o!==n&&o!==lang.placeholder){e.length||(o="",t.setContent(lang.placeholder));var i=$("#"+t.id).data("raw",o).data();i.id=t.id.substring(13),i.content=o,customBlockAction(i)}else e||t.setContent(lang.placeholder)})}})},showMessage=function(t){t&&(msgObj.html(t),msgObj.fadeIn().delay(3e3).fadeOut())},hidePositions=function(t){$.each(t,function(t,o){$("#pos-"+o).addClass("sm-inactive")})},showCurrentState=function(t,o){t?showMessage('<span><i class="fa fa-info-circle fa-blue fa-lg"></i> '+lang.hidingBlocks+"</span>"):o.length&&(showMessage('<span><i class="fa fa-info-circle fa-blue fa-lg"></i> '+lang.hidingPos+": <strong>"+o.join(", ")+"</strong></span>"),hidePositions(o))};$(document).ready(function(){editMode=window.editMode||!1,lang=window.lang||{},phpbb=window.phpbb||{},tinymce=window.tinymce||{},Twig=window.Twig||{},config=window.config||{ajaxUrl:"",boardUrl:"",route:"",ext:"",style:""};var t="",o={},e={},i={},n={},a=!1,l=$("#admin-bar").show().find("#admin-control").click(function(){if(editMode)return $(this).toggleClass("admin-bar-toggler").prev().toggle(),o.toggleClass("push-down"),!1}).find("i");if(editMode){inlineForm=$('<form class="inline-form"><input type="text" class="inline-edit" value="" /></form>').hide().appendTo($("body")),msgObj=$("#ajax-message"),emptyPositionsObj=$('.block-position:not(:has(".block"))').addClass("empty-position"),template=Twig.twig({data:$.trim($("#block-template-container").html())}),$("#add-block-panel").find(".sitemaker-block").draggable({addClasses:!1,iframeFix:!0,opacity:.7,helper:"clone",appendTo:"body",revert:"invalid",connectToSortable:".block-position",start:function(t,o){$(o.helper).addClass("dragging"),showAllPositions(),blockPositions.sortable("refresh"),e.trigger("click")},stop:function(){window.setTimeout(function(){!1===updated&&hideEmptyPositions()},600)}}),i=$("#ex_positions"),blockPositions=$(".block-position").addClass("block-receiver").sortable({revert:!0,placeholder:"ui-state-highlight grid__col sm-block-spacing block sortable placeholder",connectWith:".block-position",cancel:".editable-block, .inline-edit",items:".block",tolerance:"pointer",cursor:"move",cursorAt:{top:-10,left:-10},start:function(t,o){origin=$(o.item).addClass("dragging").parent(".horizontal"),showAllPositions(),blockPositions.sortable("refresh")},over:function(t,o){n=o.placeholder.parent(".horizontal").children(".block").addClass("sortable")},out:function(){!1===$.isEmptyObject(n)&&n.removeClass("sortable")},update:function(t,o){if(updated=!0,void 0===$(o.item).attr("id")){var e=$(this).attr("id").substring(4),i=$(o.item).attr("data-block"),n=$(this).find('div[data-block="'+i+'"]');addBlock(e,i,n)}else saveBtn.button("enable");var a=$(o.item).removeAttr("style").parent(".horizontal").children(".block"),l=$(o.item);l.parent().removeClass("empty-position"),removeGrid(l),a.length>0&&sortHorizontal(a),origin.attr("id")!==$(o.item).parent(".horizontal").attr("id")&&sortHorizontal(origin.find(".block").removeClass("sortable"))},stop:function(t,o){$(o.item).removeClass("dragging sortable").removeAttr("style"),hideEmptyPositions(),$("body").trigger("layoutChanged")}}).on("click",".block-title",function(){makeEditable($(this))}).on("submit",".inline-form",function(t){t.preventDefault(),$(this).find(".inline-edit").trigger("blur")}).on("focusout",".inline-edit",function(){processInput($(this))}).on("click",".edit-block",function(t){t.preventDefault(),blockObj=$(this).parentsUntil(".block").parent(),getEditForm(blockObj)}).on("click",".delete-block",function(t){t.preventDefault(),blockObj=$(this).parentsUntil(".block").parent(),dialogConfirm.dialog({buttons:dButtons}).dialog("open")}).each(function(){var t=$(this).attr("id").substring(4);0===i.find("option[value="+t+"]").length&&i.append('<option value="'+t+'">'+t+"</option>")}),saveBtn=$("#toggle-edit").button().click(function(){}).parent().next().children("a").button({disabled:!0}).click(function(t){t.preventDefault(),saveLayout()}),$(".has-dropdown").click(function(t){t.preventDefault(),$(this).parentsUntil("ul").parent().find(".dropped").not($(this)).removeClass("dropped").next().hide(),e=$(this).toggleClass("dropped"),e.next().toggle()}).next().mouseleave(function(){}),$("#admin-options").show(100,function(){var t=i.val();t&&showCurrentState(a,t),o=$("body").addClass("push-down")});var s=$("#style-options");s.find("option").length>1&&s.show(),$.ajaxSetup({beforeSend:function(t,o){l.addClass("fa-spinner fa-green fa-spin fa-lg fa-pulse"),o.url+=(o.url.indexOf("?")<0?"?":"&")+"style="+config.style},complete:function(t){l.delay(2e3).removeClass("fa-spinner fa-green fa-spin fa-lg fa-pulse"),t.responseJSON&&t.responseJSON.message&&showMessage(t.responseJSON.message)},error:function(t){showMessage(t.responseJSON&&t.responseJSON.message?t.responseJSON.message:lang.ajaxError)}}),eButtons[lang.edit]=function(){saveForm(blockObj)},eButtons[lang.cancel]=function(){undoPreviewBlock(),$(this).dialog("close")},dButtons[lang.remove]=function(){var t=blockObj.parent(".horizontal");blockObj.remove(),t.find(".ui-effects-placeholder").remove();var o=t.find(".block");o.length>0&&sortHorizontal(o),hideEmptyPositions(),saveBtn.button("enable"),$(this).dialog("close")},dButtons[lang.cancel]=function(){$(this).dialog("close")};var c={autoOpen:!1,modal:!0,width:"auto",show:"slide",hide:"slide"};dialogConfirm=$("#dialog-confirm").dialog(c),lButtons[lang.deleteAll]=function(){$(this).dialog("close"),$(".block-position").empty(),hideEmptyPositions(),saveBtn.button("enable"),updated=!0},lButtons[lang.cancel]=function(){$(this).dialog("close")};var r=$("#dialog-delete-all").dialog(c),d=$("#delete-blocks").button().click(function(t){t.preventDefault(),r.dialog({buttons:lButtons}).dialog("open")});cButtons[lang.copy]=function(){$(this).dialog("close"),copyBlocks(t),d.parent().show()},cButtons[lang.cancel]=function(){$(this).dialog("close")},dialogCopy=$("#dialog-copy").dialog(c),$("#copy-form").find(".layout-action").button().click(function(o){o.preventDefault(),t=$(this).parent().parent().serializeArray();var i=t[0].value,n=t[1].value,a=$(this).data("action");if(""===i||i===config.route&&n===config.style)return!1;if("copy"===a)e.trigger("click"),dialogCopy.dialog({buttons:cButtons}).dialog("open");else{var l="";l+=("/"===i.substring(0,1)?config.ajaxUrl:config.boardUrl+"/")+i,l+=(l.indexOf("?")>=0?"&":"?")+"style="+n+"&edit_mode=1",window.location.href=l}}),c.open=function(){if(!1===dialogEditOpened){var t=$(this).dialog("widget").find(".ui-dialog-buttonpane");dialogEditOpened=!0,$('<label class="dialog-check-button"><input id="update-similar" type="checkbox" />'+lang.updateSimilar+"</label>").prependTo(t)}},dialogEdit=$("#dialog-edit").dialog(c).on("click",".block-class-actions",function(t){t.preventDefault();var o=$(this).data("action"),e=dialogEdit.find("#block_class");switch(o){case"clear":e.text("").change();break;case"toggle":dialogEdit.find("#css-class-options").slideToggle();break;case"undo":case"redo":e.focus(),document.execCommand(o,!1,null),e.change()}}).on("click",".class-cat",function(t){var o=$(this).attr("href"),e=$("#classes-scroller");e.animate({scrollTop:e.scrollTop()+$(o).position().top},1e3),t.preventDefault()}).on("click",".transform",function(t){var o=dialogEdit.find("#block_class");o.focus(),document.execCommand("insertText",!1,$(this).text()+" "),o.change(),t.preventDefault()}).on("change",".block-preview",function(){previewBlock()}),$(".default-layout").button().click(function(t){var o=$(this).data("set");setDefaultLayout(o),t.preventDefault(),!0===o?($(this).parent().hide().next().hide().next().show(),d.parent().hide()):($(this).parent().hide().prev().hide().prev().show(),d.parent().show())}),$(".sm-startpage").button().click(function(t){t.preventDefault();var o={};"set-startpage"===$(this).attr("id")?($(this).parent().hide().next().show(),o={controller:$(this).data("controller"),method:$(this).data("method"),params:$(this).data("params")},setStartPage(o)):($(this).parent().hide().prev().show(),setStartPage(o))}),a=$("#route-settings").submit(function(t){setRoutePrefs($(this),i.val()),t.preventDefault()}).find("#hide_blocks").is(":checked"),window.onbeforeunload=function(t){if(!0===updated)return t=t||window.event,t&&(t.returnValue=lang.leaveConfirm),lang.leaveConfirm},$(".sitemaker").iconPicker({selector:".block-icon",onSelect:function(t,o){var e=t.parentsUntil(".block").parent().attr("id").substring(6);updateBlock({id:e,icon:o})}}),initTinyMce()}})}(jQuery,window,document);
//# sourceMappingURL=manager.min.js.map
